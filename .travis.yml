services:
  - docker

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2
    - secure: "Dg2lEEVGX4gCC9TX2NmkrMomoT+pNnd0vSgwzYV1BLKAEcaPUaglIC3Ce7gMWGxyKwlIUySfcDL3Jqe+a/eWitVtfWslHe5o9QDbSxuYXmwi30AA5wtssL7O8QCaqPWDxtWNq1et5J7M+Br/5boIlMOv3DRDoIAO/4S4JxDx62rZU5l9S0KAaJTb68ZND5HGcZWJXWu7t4t1uChi8eE5yL2W+PSTGMGRRyXwzJ87XaiR/+RBwpEs00+9+pmB1ZvYYrgTand5W51bUYnrkCqtqDaWzASo+kE4lH88iA5q6vQnLs2WSflvpNfDtM0OgiD8WhP/ie/IKdiJ9r8L3sIEZvRAE+6zuHM8l4ypxIjNdZJh5P6ZpN1z+ZjpG0cJx7mlcUDuWPyIrIvrtBgRtIWWfn8QOwiYqTFc3JtJl9ksnIUWErrIoH7Dl5gCxGvt+3s3XjdICIzLU6II1Q4lZQoRtWEGP0G2RU+kHFdOAeS19i3ZsyDMeWd+/yvHrd/SFnjm8IBXxeSrxUCu6eaSWbkrkQ/Ho1+kiLh602yMWPPJfrvtFKpNrBxvRGXxNe5sDTaBaqIiZtaCinOeJYswZNen9KepD5o6AHEJXQhNYemoHvFaEicL/B8Rur2ITZaGriI9gxtafFY05q4iIyeC27IZzvJGtYTL2mti8z4dZTjWmYQ="
    - secure: "jhCAziN6ZAFr+A0wa0ksnsRn8ZonhQv5LZK7cRdh/btP0PxXBmZxezJ8O/XvsqgYHkdwtBzG1lMHMRB8Un6aObKklvrLEFv4QK1Rl1EVr94w9EasOMG2TxZ5rDM4RBYwvsxiBHUfZLj+OlLfBbFhycqVGcIy3XkMF1wfmP2im3acTuyuQA9kw7I3jcSYja1K6++KDRhQMkjyYI/6wOPZ2znU5Dxt3iG7eHKkEGgB6pOi3oYTmA1AGWL+QOVqDaWKgD23BlTaZ0Yr1oc3n9p1I5mzotaw4JXDIuSZMMqtpAkeCinuzjC5/lKAuq/rxeHSNXVYvQST+1pQ5hqKxqZgZFVLr5+GTMnDL57yPQe/XajG2XDfBfQXliO+17tFkPBmCaUe1vnZBzITYiqQe1tsCTgI1TXYIlGnSXbQmzQ/2NptSe6XcxFSzPBE3rG+g7g1nlqMPZGQ59H6t7e3/L5G3/2MGqa6tNmmvshRsrRxpc0f9qLVYOi0Q6sqF/USE9CqyGppm6rHFKGJAzdAqo+y8SjUsTj1PnCM/nC8bm8+VMVDeprjOlxXOkb/+gBnKdmm8f4RxlB9NT5aLVtBBHtIDvB8anOoSbQLJEhXtzwumC/7FIGyNAFB/0iIZyZrF8Nelr5kY0CdDXovqozQkGLqGuHRuanCrarTfFkbQMFv5Yw="

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker --version
  - docker-compose version
  - echo "Login into Docker Hub"
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - export GIT_SHA=`git rev-parse --short HEAD`
  - echo "Building commit $GIT_SHA"

jobs:
  include:
    - stage: tests
      name: "Unit Tests"
      script:
        - cd ch4
        - docker-compose build db
        - docker-compose build test-postgresql
        - docker-compose run test-postgresql
    - stage: tests
      name: "Static Analysis"
      script:
        - cd ch4
        - docker-compose build static-analysis
        - docker-compose run static-analysis
    - stage: push
      script:
        - cd ch4
        - docker-compose build server
        - docker tag thoughts_server:latest jaimebuelta/thoughts-backend:$GIT_SHA
        - docker push jaimebuelta/thoughts-backend:$GIT_SHA
        - docker tag thoughts_server:latest jaimebuelta/thoughts-backend:$TRAVIS_BRANCH
      deploy:
        - provider: script
          script: docker push jaimebuelta/thoughts-backend:$TRAVIS_BRANCH
          on:
            branch: master
        - provider: script
          script: docker push jaimebuelta/thoughts-backend:$TRAVIS_TAG
          on:
            tags: True
